<html>
<head>
    <meta charset="utf-8">	
	<meta property="og:type" content="website" />
	<meta property="og:url" content="http://www.peterma.de/munithismoment" />
	<meta property="og:title" content="Muni, this moment" />
	<meta property="og:image" content="http://peterma.de/munithismoment/teaser.png" />



	<link rel="stylesheet" href="style.css">
	<title>Muni, this moment</title>
</head>
<body>
	<div style='display:none'>
		<img src='teaser.png'>
		<img src='teaser2.png'>
		<img src='teaser3.png'>
		<img src='teaser4.png'>		
	</div>
	<div style="opacity:0" onclick='zoombackout()' id='zoomout'><br>Zoom<br>out</div>
	<div id='satellite' style='display:none'>Finding your location...</div>
	<div id='loader'>


<svg  width="300px" height="300px" style='margin-top:200px'>

	
		<radialGradient id="SVGID_1_" cx="141.2695" cy="142.6191" r="136.5" gradientTransform="matrix(1.0989 0 0 1.0989 -5.2419 -6.7253)" gradientUnits="userSpaceOnUse">
		<stop  offset="0" style="stop-color:#FFFFFF"/>
		<stop  offset="1" style="stop-color:#FFFFFF;stop-opacity:0"/>
	</radialGradient>
	<circle fill="url(#SVGID_1_)" cx="150" cy="150" r="150"/>

			<g transform='scale(3) translate(50, 40)'>
				<path  id='spinner' d="M-5.392-5.018c-2.977,2.979-2.977,7.807,0,10.783c2.978,2.979,7.805,2.979,10.783,0c2.979-2.977,2.979-7.805,0-10.783l-5.392-5.391L-5.392-5.018z"; fill='#41A6B2' transform='' style='-webkit-transform-origin:50%'/>
			</g>	
	<text x='150' y='210' text-anchor='middle' id='loadermessage'>Fetching buses...</text>

</svg>






	</div>
	<div id='svg' class='blurred'></div>
	<div id='maindialog' >
		<h3>Muni, this moment</h3>
		<span id='busquant'></span> buses, <span id='trainquant'></span> trains active
		<p>
		This is a live map of San Francisco's Muni system, as reported by NextBus. Click to inspect any line.
	</p>
	<p class='subhead'>Look nearby (SF only)</p><div id='findme' onclick='gps()'>Find me</div>

	<p class='subhead'>Find a specific line</p>
	<div class='inputbubble'id='routedirection' val='_OB'>
		<div class="onoffswitch">
		    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch">
		    <label class="onoffswitch-label" for="myonoffswitch">
		        <div class="onoffswitch-inner">
		        	<span id='IB' onclick='$("#routedirection").attr("val","_OB");lookup()'>Inbound</span>
		        	<span id='OB' onclick='$("#routedirection").attr("val","_IB");lookup()'>Outbound</span>		        	

		        </div>
		        <div class="onoffswitch-switch" ></div>
		    </label>
		</div>
			<input type='text' placeholder='Line #' id='routenumber' onkeydown="$('#searchreply').html(''); if (event.keyCode == 13) {lookup()}"/>
			<span id='searchreply' style='float:right;margin: 6px; opacity: 0.8;'></span>
	</div>



	



		<div class='flipper' style='display:none' onclick='$(this).toggleClass("flipped")' direction='_IB'>
			<div class='side' id='out' onclick="$('.flipper').attr('direction','_IB')">
				Outbound &#x25BC;
			</div>
			<div class='side' id='in' onclick="$('.flipper').attr('direction','_OB')">
				Inbound &#x25BC;
			</div>			
		</div>


	</div>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="firebase.js"></script>
    <script src="firebus-modified.js"></script>
	<script src="pep.edited.min.j"></script>


	   
    <script>

		window.dragreset='no';

    	$('#svg').load('sfmap.svg');
		//$('#dragger').pep({});


		//defines functionality of moving markers to the front when clicked
		d3.selection.prototype.moveToFront = function() {
		  return this.each(function(){
		    this.parentNode.appendChild(this);
		  });
		};
		
    	// LAT-LON MASTER CONVERTERS
    	function lonx(lon){
    		return (8823*lon)+1081060-4;
    	}
    	function laty(lat) {
	    	return 422405-(11164.4*lat);
    	}

    	//places dot given lat-lon

    	function current_location(lat,lon) {

			if($('#iamhere').length==0){
	    		d3.select('#markers')
	    		.append('circle')
	    		.attr('cx',lonx(lon))
	    		.attr('cy',laty(lat))
	    		.attr('id','iamhere')
	    		.on('mouseout',function(){removelabel()});				

	    		d3.select('#findme')
	    		//.on('click',function(){zoomto(lonx(lon),laty(lat));
	    		$('.busmarker').attr('class','busmarker selected');
				};

			
			
			d3.select('#iamhere')
	    		.attr('cx',lonx(lon))
	    		.attr('cy',laty(lat))			
	    		.attr('r',4)	
	    		.on('mouseover',function(){
	    			var position= Math.round(lat*1000)/1000+' latitude, '+Math.round(lon*1000)/1000+' longitude';
	    			makelabel(lonx(lon),laty(lat),"That's you!",'orange','(Location based on IP address)')})
	    		.on('click', function(){
	    			var myx= $(this)[0].getAttribute('cx');
	    			var myy= $(this)[0].getAttribute('cy');

	    			zoomto(myx,myy);
	    			$('.busmarker').attr('class','busmarker selected');
	    			$('.stopmarker').remove();

	    		})
			
	    	
    	}

		
		//Contingencies    
		function show_map_error() {};
		function supports(bool, suffix) {
  var s = "Your browser ";
  if (bool) {
    s += "supports " + suffix + ".";
  } else {
    s += "does not support " + suffix + ". :(";
  }
  return s;
};        	
 	
		//detects whether geolocation is possible
		$(function() {
		  if (geoPosition.init()) {
		    $("#live-geolocation").html(supports(true, "geolocation") + ' <a href="#" onclick="lookup_location();return false">Click to look up your location</a>.');
			} 
		  else {$("#live-geolocation").html(supports(false, "geolocation")); 
		  		$('#findme').remove();
				}
		});    	
				
		function zoomto(x,y) {
			if($('.zoomed').length!=0){
				dragreset='yes';
			}
			//$('#dragger').pep({cssEaseString:''});
			$('#zoomout').attr('style','');
			
				d3.select('#viewport')
				.attr('style','-webkit-transform-origin:'+(1.6*x-600)+' '+(1.4*y-400)+'; ')
				.attr('class','viewport zoomed');
			$('#dragger').attr('style','-webkit-transform:translate(0,0); -webkit-transition:all 2s');

			removelabel();
		};

		function lookup() {
			var number=$('#routenumber').val().toUpperCase();
			var direction=$('#routedirection').attr('val');
			var targetbuses=$('g[route='+number+'][direction="'+direction+'"]');

			if (number.length!=0){
				if (targetbuses.length==0) {$('#searchreply').html('No results')}

				else {
					var horiz= targetbuses[0].getAttribute('xcoord');
					var vert= targetbuses[0].getAttribute('ycoord');

					$('#searchreply').html(targetbuses.length+' found')
					zoomto(horiz, vert);
					showbusesonline(number,direction);
					showroutestops(number+direction);
					$('input').blur();
					//console.log(number+direction);
				}
			}
		}

		//Emerge stop markers when a bus is clicked
		function showroutestops(routedir){
		
			//clears previous stop markers
			$('.stopmarker').remove();
			
			d3.json('truncated_stops.json',function(json){
			
			window.data=json[routedir]['Stops'];
			
			
			d3.select('#busstops')
				.selectAll("circle")
				.data(data)
				.enter()
				.append("circle")
				.attr("r", 0)
				.attr('class','stopmarker')
				.attr('cx',function(d,i){return lonx(data[i]['Lon'])})
				.attr('cy',function(d,i){return laty(data[i]['Lat'])})				
				.attr('fill',function(d,i) {if (i!=0 && i!=data.length-1){if (routedir.indexOf('OB')> -1) {return outboundcolor} else {return inboundcolor}} else {return 'white'}})
				.attr('stroke',function(d,i) {if (i!=0 && i!=data.length-1) {return 'white'} 
												else {if (routedir.indexOf('OB')> -1) {return outboundcolor} 
													else {return inboundcolor}}})
				.attr('stroke-width',function(d,i) {if (i!=0 && i!=data.length-1){return 1} else {return 2.5}})
				//.attr('name',function(d,i){return data[i]['Intersection']})

				.on('mouseover',function(d,i){
					d3.select(this)
						.transition()
						.duration(200)
						.attr('r',function(){ return ($(this)[0].getAttribute('r'))*1.5});

					var color= function(){if (routedir.indexOf('OB')> -1) {return outboundcolor} else {return inboundcolor}};
					var stopdirection= function() {if (routedir.indexOf('OB')> -1) {if (i==0) {return 'Outbound line departs here'}  if (i==data.length-1){return 'Outbound line ends here'} else {return ' Outbound stop'}} 
													else {if (i==0) {return 'Inbound line departs here'}  if (i==data.length-1){return 'Inbound line ends here'} else {return 'Inbound stop'}}};


					makelabel(lonx(data[i]['Lon']),laty(data[i]['Lat']),data[i]['Intersection'],color, stopdirection);
					
			
				})
				.on('mouseout', function (){
					d3.select(this)
						.transition()
						.duration(200)
						.attr("r", 3);

					removelabel();
				})
				.transition()
				.delay(function(d,i){return 5*i})
				.duration(500)
				//.attr('size',function(d,i) {if (i!=0 && i!=data.length-1){return 3} else {return 5}})
				.attr("r", 3)
			})
			
		}
		
		//When a bus is clicked, grey out all buses that aren't on the same line, reveal stops, and move relevant stops and buses to the top of the stack		
		function showbusesonline(line,direction) {

			if (direction!=null) {
				$('.busmarker:not([route="' +line+ '"][direction="'+direction+'"])').attr('class','busmarker unselected');
				$('.busmarker[route="' +line+ '"][direction="'+direction+'"]').attr('class','busmarker selected');				
			}
			else {
				$('.busmarker:not([route="'+line+'"])').attr('class','busmarker unselected');
				$('[route="'+line+'"]').attr('class','busmarker selected');
			}

			d3.select('#busstops').moveToFront();
			d3.selectAll('.selected').moveToFront();
		}
		
		//Restore view to full, remove all stop markers and restore all buses to full color
		function zoombackout() {
			dragreset='yes';
			$('#dragger').attr('style','-webkit-transform:translate(0,0); -webkit-transition:all 2s');
			$('#view').attr('class','');
			$('#zoomout').attr('style','opacity:0');

			d3.select('.viewport')
			.attr('style','')
			.attr('class','viewport');
						
			$('.busmarker').attr('class','busmarker');
			$('.stopmarker').remove();
			removelabel();


		}
		
		//hack to fix erroneous routdirs
		function fudge(routedir){
			var lastB= routedir.lastIndexOf('B');
			return routedir.substr(0,lastB+1);
			
		}
		
		window.labelscalefactor;

		//make label
		function makelabel(x,y,text,textcolor,subtext) {
					
					if ($('.zoomed').length==0) {
						labelscalefactor=' scale(2)';
					}
					else {labelscalefactor=' scale(1)'}
					d3.selectAll('#stoplabel').remove();
					console.log($('body:active').length);
					if ($('body:active').length==0){
						d3.select('#busstoplabels')
							.attr('transform','translate('+(x+26)+' '+(y-10)+') '+labelscalefactor)					
							.append('text')
							.attr('x',6)
							.attr('y',15)
							.attr('font-size',8)
							.attr('fill',textcolor)
							.text(text)						
							.attr('id','stoplabel');

						d3.select('#busstoplabels')
							.append('text')
							.attr('x',6)
							.attr('y',25)
							.attr('font-size',6)
							.text(subtext)						
							.attr('id','stoplabel')
							.attr('class','subtext');
						
						//create background rectangle for label
						d3.select('#busstoplabels')
							.insert('rect','text')
							.attr('width',function(){return Math.max($('#stoplabel')[0].getComputedTextLength(), $('.subtext')[0].getComputedTextLength())+12})	
							.attr('height',32)
							.attr('id','labelrect');
					}
						
		}
		
		function removelabel() {
					d3.selectAll('#stoplabel').remove();
					d3.selectAll('#labelrect').remove();
		}
		

		function countbuses() {
			  //count buses and trains
			  var busquant=$('[type="bus"]').length;
			  var trainquant=$('[type="train"]').length;

			  $('#busquant').text(busquant);
			  $('#trainquant').text(trainquant);
		}		
		//Update user position		

		function gps(){
		window.finding=setInterval(function() {
			if ($('#iamhere').length==0) {
				$('#loadermessage').html('Finding your position...');
				$('#svg').addClass('blurred');
				$('#loader').show();

				geoPosition.getCurrentPosition(get_latlon, show_map_error);
				current_location(lat,lon); console.log('poll'); 

			}
			if ($('#iamhere').length!=0) {
				clearInterval(finding); 
				$('#loader').hide();
				$('#svg').removeClass('blurred');
				if((lon>= -122.516613) && (lon<=-122.358685) && (lat<=37.841898) && (lat>=37.702273))
					{zoomto(lonx(lon),laty(lat));}
				else 
					{alert("Whoops, it doesn't look like you're in the area")};
			}
		}, 10);
		}
		
		//$("svg").on('mousemove',function(e){ 
            //$("#busstoplabels").attr("transform", "translate(" + [e.pageX+335] + "," + [e.pageY+60] + ")"); 
			//}); 

		



    </script>


    	<script src="geoPosition.js"></script>
</body></html>