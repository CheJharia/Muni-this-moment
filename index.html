<html>
<head>
    <meta charset="utf-8">	
	<meta property="og:type" content="website" />
	<meta property="og:url" content="http://www.peterma.de/munithismoment" />
	<meta property="og:title" content="Muni, this moment" />
	<meta property="og:image" content="http://peterma.de/munithismoment/teaser.png" />



	<link rel="stylesheet" href="style.css">
	<title>Muni, this moment</title>
</head>
<body>
	<div style='display:none'>
		<img src='teaser.png'>
		<img src='teaser2.png'>
		<img src='teaser3.png'>
		<img src='teaser4.png'>		
	</div>
	<div style="opacity:0" onclick='zoombackout()' id='zoomout'><br>Zoom<br>out</div>
	<div id='satellite' style='display:none'>Finding your location...</div>
	<div id='loader'>


	<svg  width="300px" height="300px" style='margin-top:200px'>

		
		<radialGradient id="SVGID_1_" cx="141.2695" cy="142.6191" r="136.5" gradientTransform="matrix(1.0989 0 0 1.0989 -5.2419 -6.7253)" gradientUnits="userSpaceOnUse">
			<stop  offset="0" style="stop-color:#FFFFFF"/>
			<stop  offset="1" style="stop-color:#FFFFFF;stop-opacity:0"/>
		</radialGradient>
		<circle fill="url(#SVGID_1_)" cx="150" cy="150" r="150"/>
				<g transform='scale(3) translate(50, 40)'>
					<path  id='spinner' d="M-5.392-5.018c-2.977,2.979-2.977,7.807,0,10.783c2.978,2.979,7.805,2.979,10.783,0c2.979-2.977,2.979-7.805,0-10.783l-5.392-5.391L-5.392-5.018z"; fill='#41A6B2' transform='' style='-webkit-transform-origin:50%;fill-opacity:0.5;'/>
				</g>	
		<text x='150' y='210' text-anchor='middle' id='loadermessage'>Fetching buses...</text>
	</svg>






</div>
	<div id='svg' class='blurred'></div>
	<div id='maindialog' >
		<h3>Muni, this moment</h3>
		<span id='busquant'></span> buses, <span id='trainquant'></span> trains active
		<p>
		This is a live map of San Francisco's Muni system, as reported by NextBus. Click to inspect any line.
	</p>
	<p class='subhead'>Look nearby (SF only)</p><div id='findme' onclick='gps()'>Find me</div>

	<p class='subhead'>Find a specific line</p>
	<div class='inputbubble'id='routedirection' val='_OB' onclick='$("#routenumber").focus()'>
		<div class="onoffswitch">
		    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch">
		    <label class="onoffswitch-label" for="myonoffswitch">
		        <div class="onoffswitch-inner">
		        	<span id='IB' onclick='$("#routedirection").attr("val","_OB");lookup()'>Inbound</span>
		        	<span id='OB' onclick='$("#routedirection").attr("val","_IB");lookup()'>Outbound</span>		        	

		        </div>
		        <div class="onoffswitch-switch" ></div>
		    </label>
		</div>
			<input type='text' placeholder='Line #' id='routenumber' onkeydown="$('#searchreply').html(''); if (event.keyCode == 13) {lookup()}"/>
			<span id='searchreply' style='float:right;margin: 6px; opacity: 0.8;'></span>
	</div>



	



		<div class='flipper' style='display:none' onclick='$(this).toggleClass("flipped")' direction='_IB'>
			<div class='side' id='out' onclick="$('.flipper').attr('direction','_IB')">
				Outbound &#x25BC;
			</div>
			<div class='side' id='in' onclick="$('.flipper').attr('direction','_OB')">
				Inbound &#x25BC;
			</div>			
		</div>


	</div>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="firebase.js"></script>
    <script src="firebus-modified.js"></script>
	<script src="pep.edited.min.js"></script>


	   
    <script>

		window.dragreset='no';

    	$('#svg').load('sfmap.svg');
		$('#dragger').pep({});


		//defines functionality of moving markers to the front when clicked
		d3.selection.prototype.moveToFront = function() {
		  return this.each(function(){
		    this.parentNode.appendChild(this);
		  });
		};
		
    	// LAT-LON MASTER CONVERTERS
    	function lonx(lon){
    		return (8823*lon)+1081060-4;
    	}
    	function laty(lat) {
	    	return 422405-(11164.4*lat);
    	}

    	//places dot given lat-lon

    	function current_location(lat,lon) {

			if($('#iamhere').length==0){
	    		d3.select('#markers')
	    		.append('circle')
	    		.attr('cx',lonx(lon))
	    		.attr('cy',laty(lat))
	    		.attr('id','iamhere')
	    		.on('mouseout',function(){removelabel()});				

	    		d3.select('#findme')
	    		//.on('click',function(){zoomto(lonx(lon),laty(lat));
	    		$('.busmarker').attr('class','busmarker selected');
				};

			
			
			d3.select('#iamhere')
	    		.attr('cx',lonx(lon))
	    		.attr('cy',laty(lat))			
	    		.attr('r',4)	
	    		.on('mouseover',function(){
	    			var position= Math.round(lat*1000)/1000+' latitude, '+Math.round(lon*1000)/1000+' longitude';
	    			makelabel(lonx(lon),laty(lat),"That's you!",'orange','(Location based on IP address)')})
	    		.on('click', function(){
	    			var myx= $(this)[0].getAttribute('cx');
	    			var myy= $(this)[0].getAttribute('cy');

	    			zoomto(myx,myy);
	    			$('.busmarker').attr('class','busmarker selected');
	    			$('.stopmarker').remove();

	    		})
			
	    	
    	}

		
		//Contingencies    
		function show_map_error() {};
		function supports(bool, suffix) {
  var s = "Your browser ";
  if (bool) {
    s += "supports " + suffix + ".";
  } else {
    s += "does not support " + suffix + ". :(";
  }
  return s;
};        	
 	
		//detects whether geolocation is possible
		$(function() {
		  if (geoPosition.init()) {
		    $("#live-geolocation").html(supports(true, "geolocation") + ' <a href="#" onclick="lookup_location();return false">Click to look up your location</a>.');
			} 
		  else {$("#live-geolocation").html(supports(false, "geolocation")); 
		  		$('#findme').remove();
				}
		});    	
				
		function zoomto(x,y) {

			//if it's already in a zoomed state
				dragreset='yes';
			


			$('#viewport').attr('style','-webkit-transform-origin:'+(1.5*x-500)+' '+(1.7*y-400)+'; ');		
				
			setTimeout(function() { $('#viewport').attr('class','viewport zoomed'); }, 0);

						

			$('.viewport').attr('highlighting','no');
			$('#zoomout').attr('style','');
			$('#dragger').attr('style','-webkit-transform:translate(0,0); -webkit-transition:all 1.5s');

			removelabel();
		};

		function lookup() {
			var number=$('#routenumber').val().toUpperCase();
			var direction=$('#routedirection').attr('val');
			var targetbuses=$('g[route='+number+'][direction="'+direction+'"]');

			if (number.length!=0){
				if (targetbuses.length==0) {$('#searchreply').html('No results')}

				else {

					//zoom in on the center bus in the DOM (more likely to be near center of map)
					var middlebus= Math.ceil((targetbuses.length)*0.5);
					var horiz= targetbuses[middlebus].getAttribute('xcoord');
					var vert= targetbuses[middlebus].getAttribute('ycoord');

					$('#searchreply').html(targetbuses.length+' found')
					zoomto(horiz, vert);
					showbusesonline(number,direction);
					showroutestops(number+direction);
					drawpath(number+direction);
					$('input').blur();
					//console.log(number+direction);
				}
			}
		}


		//draw the overall route path
		function drawroute(line,color){
			d3.json('stops.refactored.v3.json',function(json){
				//alert('sdfsd');
				var data=json['RoutePaths'][line]['Subsegments'];
				//console.log(json['RoutePaths'][22]['Subsegments'])
				d3.select('#busstops')
					.selectAll('path')
					.data(data)
					.enter()
					.append("path")
					.attr('d',function(d,i){return data[i]})
					.attr('stroke-width', 3)
					.attr('class','routepatha')
					.attr('fill','none')
					.attr('stroke','purple');

			})
		}

		//draw bus route based on stops' positions only
		function drawpath(routedir,marker){
			$('.routepath').remove();

				var directionColor = routedir.indexOf('OB') > -1 ? outboundcolor : inboundcolor;

				d3.json('stops.refactored.v3.json',function(json){
				
					var data=json[routedir]['Stops'];
					var datalen=data.length;
					var pathdata=json[routedir]['Path'];

					d3.select('#markers')
						.append("path")
						.attr('d',pathdata)
						.attr('class','routepath')
						.attr('fill','none')
						.attr('stroke',directionColor)
						.attr('stroke-linecap','round')
						.attr('stroke-linejoin','round');
					setTimeout(function() { $('.routepath').attr('style','stroke-dashoffset:0'); }, 0);
					

					//define the position of both ends of the route for the endcaps
					var endcaps=[data[0]['xpos'], data[0]['ypos'], data[datalen-1]['xpos'], data[datalen-1]['ypos']];
					
					//draw endcap circles for the route
					for (k=0;k<2;k++){
						d3.select('#markers')
							.append("circle")
							.attr('cx',endcaps[k*2])
							.attr('cy',endcaps[(k*2)+1])
							.attr('r',4)
							.attr('class','routepath coast')
							//.attr('fill', 'none')
							.attr('stroke',directionColor)
					}
				})
		}
		//Emerge stop markers when a bus is clicked
		function showroutestops(routedir,color,vtype){
		
			//clears previous stop markers
			$('.stopmarker').remove();

			if ($('.zoomed').length==1)	
				{
				drawpath(routedir);	

				setTimeout(function(){
					d3.selectAll('#busstops').moveToFront();
					d3.selectAll('.selected').moveToFront();
				},10);	
				}

			d3.json('stops.refactored.v3.json',function(json){
			
			var data=json[routedir]['Stops'];
			
			
			d3.select('#busstops')
				.selectAll("circle")
				.data(data)
				.enter()
				.append("circle")
				.attr("r", 0)
				.attr('class','stopmarker')
				.attr('tag',function(d,i){return data[i]['Tag']})
				.attr('stoptype',function(d,i) {if (i!=0 && i!=data.length-1){return 'stop'} else {return 'terminal'}})
				.attr('direction',function(d,i) {if (routedir.indexOf('OB')> -1) {return '_OB'} else {return '_IB'}})
				.attr('cx',function(d,i){return data[i]['xpos']})
				.attr('cy',function(d,i){return data[i]['ypos']})				
				.attr('stroke-width',function(d,i) {if (i!=0 && i!=data.length-1){return 1.5} else {return 2.5}})
				.on('mouseover',function(d,i){

					//Generate label
					var color= function(){if (routedir.indexOf('OB')> -1) {return outboundcolor} else {return inboundcolor}};
					var stopdirection= function() {if (routedir.indexOf('OB')> -1) {if (i==0) {return 'Outbound line departs here'}  if (i==data.length-1){return 'Outbound line ends here'} else {return ' Outbound stop'}} 
													else {if (i==0) {return 'Inbound line departs here'}  if (i==data.length-1){return 'Inbound line ends here'} else {return 'Inbound stop'}}};
					makelabel(data[i]['xpos'], data[i]['ypos'], data[i]['Intersection'], color, stopdirection);

					//get bus prediction
					var stoptag=$(this)[0].getAttribute('tag');
					var justtheroute=routedir.substr(0,routedir.lastIndexOf("_"));
					
					getprediction(justtheroute,stoptag, vtype);		
				})
				.on('mouseout', function (){
					removelabel();
					$(this).attr('r',2.5);					
				})
				.transition()
				.delay(function(d,i){return 5*i})
				.duration(500)
				.attr("r", 2.5)
			})
			d3.select('.busmarker:hover').moveToFront();
		}
		
		//When a bus is clicked, grey out all buses that aren't on the same line, reveal stops, and move relevant stops and buses to the top of the stack		
		function showbusesonline(line,direction) {

			if (direction!=null) {
				$('.busmarker:not([route="' +line+ '"][direction="'+direction+'"])').attr('class','busmarker unselected');
				$('.busmarker[route="' +line+ '"][direction="'+direction+'"]').attr('class','busmarker selected');				
			}
			else {
				$('.busmarker:not([route="'+line+'"])').attr('class','busmarker unselected');
				$('[route="'+line+'"]').attr('class','busmarker selected');
			}

			d3.select('#busstops').moveToFront();
			d3.selectAll('.selected').moveToFront();
		}
		
		//Restore view to full, remove all stop markers and restore all buses to full color
		function zoombackout() {
			dragreset='yes';
			$('.viewport').attr('highlighting','no');						
			$('#dragger').attr('style','-webkit-transform:translate(0,0); -webkit-transition:-webkit-transform 1s');
			$('#view').attr('class','');
			$('#zoomout').attr('style','opacity:0');

			d3.select('.viewport')
				.attr('class','viewport');
						
			$('.busmarker').attr('class','busmarker');
			$('.stopmarker').remove();
			$('.routepath').remove();
			removelabel();


		}
		
		//hack to fix erroneous routdirs
		function fudge(routedir){
			var lastB= routedir.lastIndexOf('B');
			return routedir.substr(0,lastB+1);
			
		}
		
		window.labelscalefactor;

		//make label
		function makelabel(x,y,text,textcolor,subtext) {
					removelabel();
					if ($('.zoomed').length==0) {
						labelscalefactor=' scale(1.8)';
					}
					else {labelscalefactor=' scale(1)'}
					d3.selectAll('#stoplabel').remove();

					//Fire only when the mouse isn't already held down (i.e. dragging)
					if ($('body:active').length==0){
						d3.select('#busstoplabels')
							.attr('transform','translate('+(x+8)+' '+(y-10)+') '+labelscalefactor)					
							.append('text')
							.attr('x',6)
							.attr('y',15)
							.attr('font-size',8)
							.attr('fill',textcolor)
							.text(text)						
							.attr('id','stoplabel');

						d3.select('#busstoplabels')
							.append('text')
							.attr('x',6)
							.attr('y',25)
							.attr('font-size',6)
							.text(subtext)						
							.attr('id','stoplabel')
							.attr('class','subtext');
						
						//create background rectangle for label
						d3.select('#busstoplabels')
							.insert('rect','text')
							.attr('width',function(){return Math.max($('#stoplabel')[0].getComputedTextLength(), $('.subtext')[0].getComputedTextLength())+12})	
							.attr('height',32)
							.attr('id','labelrect');
					}
						
		}
		
		function removelabel() {
					d3.selectAll('#stoplabel').remove();
					d3.selectAll('#labelrect').remove();
		}
		

		function countbuses() {
			  //count buses and trains
			  var busquant=$('[type="bus"]').length;
			  var trainquant=$('[type="train"]').length;

			  $('#busquant').text(busquant);
			  $('#trainquant').text(trainquant);
		}		
		//Update user position		

		function gps(){

		window.finding=setInterval(function() {
			if ($('#iamhere').length==0) {
				$('#loadermessage').text('Finding your position...');
				$('#spinner').attr('fill','purple');
				$('#svg').addClass('blurred');
				$('#loader').show();

				geoPosition.getCurrentPosition(get_latlon, show_map_error);
				current_location(lat,lon); console.log('poll'); 

			}
			if ($('#iamhere').length!=0) {
				clearInterval(finding); 
				$('#loader').hide();
				$('#svg').removeClass('blurred');
				if((lon>= -122.516613) && (lon<=-122.358685) && (lat<=37.841898) && (lat>=37.702273))
					{zoomto(lonx(lon),laty(lat));}
				else 
					{alert("Whoops, it doesn't look like you're in the area")};
			}
		}, 0);
		}
		


		function getprediction(route, stoptag, vtype) {
			var targeturl='http://webservices.nextbus.com/service/publicXMLFeed?command=predictions&a=sf-muni&r='+route+'&s='+stoptag;
			console.log(targeturl);
			
			$.ajax({
		      	dataType: "xml",
		      	url: targeturl,
		      	success: function(response) {		  
		      		var result=response;
		      		
			  		var path="//prediction/@seconds";

			  		var nodes=result.evaluate(path, result, null, XPathResult.ANY_TYPE, null);
					var result=nodes.iterateNext();
					window.predictionlist=[];
					while (result)
						{
							predictionlist.push(result.childNodes[0].nodeValue);  
							result=nodes.iterateNext();
						}
				
					console.log(predictionlist);
					
					function timeconverter(seconds){
						var minutes=Math.round(seconds/60);
						if(seconds<60){ return seconds+' seconds'}
						
						else {
							if(minutes>1){return minutes+' minutes'}
							else {return minutes+' minute'}
						}
					}
					
					$('.subtext').text('Next '+vtype+' in '+timeconverter(predictionlist[0]));
					
					//resize background rectangle
					$('#labelrect').attr('width',function(){return Math.max($('#stoplabel')[0].getComputedTextLength(), $('.subtext')[0].getComputedTextLength())+12})	

		      	}
		    });
		}
		
		function w3schools(route, stoptag, vtype) {
		
		
			function loadXMLDoc(dname)
				{
				xhttp=new XMLHttpRequest();
				xhttp.open("GET",dname,false);
				xhttp.send("");
				return xhttp;
				}
		
		
			var targeturl='http://webservices.nextbus.com/service/publicXMLFeed?command=predictions&a=sf-muni&r='+route+'&s='+stoptag;
			var x=loadXMLDoc(targeturl);
			var xml=x.responseXML;
			var path="/body/predictions/direction/@seconds";
			
			var nodes=xml.evaluate(path, xml, null, XPathResult.ANY_TYPE, null);
			var result=nodes.iterateNext();
			window.predictionlist=[];

			while (result)
			  {
				  predictionlist.push(result.childNodes[0].nodeValue);
				  console.log(result.childNodes[0].nodeValue);
				  result=nodes.iterateNext();  
			  }
			console.log(xml);
		}		
    </script>


    <script src="geoPosition.js"></script>
</body></html>