<html>
<head>
	<link rel="stylesheet" href="style.css">
</head>
<body>


	<div id='svg' class=''></div>


<div style="opacity:0" onclick='zoombackout()' id='zoomout'><br>Zoom<br>out</div>



	<script src='jquery-1.9.1.min.js'></script>	
	<script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="firebase.js"></script>
    <script src="firebus-modified.js"></script>


	   
    <script>


    	$('#svg').load('sfmap.svg');

				
		//defines functionality of moving markers to the front when clicked
		d3.selection.prototype.moveToFront = function() {
		  return this.each(function(){
		    this.parentNode.appendChild(this);
		  });
		};
		
    	// LAT-LON MASTER CONVERTERS
    	function lonx(lon){
    		return (8823*lon)+1081060-4;
    	}
    	function laty(lat) {
	    	return 422405-(11164.4*lat);
    	}

    	//places dot given lat-lon

    	function current_location(lat,lon) {

			if($('#iamhere').length==0){
	    		d3.select('#markers')
	    		.append('circle')
	    		.attr('cx',lonx(lon))
	    		.attr('cy',laty(lat))
	    		.attr('id','iamhere')
	    		.on('mouseout',function(){removelabel()});				
			}
			
			d3.select('#iamhere')
	    		.attr('cx',lonx(lon))
	    		.attr('cy',laty(lat))				
	    		.on('mouseover',function(){makelabel(lonx(lon),laty(lat),"We're somewhere here",'purple',lat+', '+lon)})
	    		.on('click', function(){
	    			var myx= $(this)[0].getAttribute('cx');
	    			var myy= $(this)[0].getAttribute('cy');

	    			zoomto(myx,myy);
	    			$('.busmarker').attr('class','busmarker selected');
	    			$('.stopmarker').remove();

	    		})
			
	    	
    	}

		
		//Contingencies    
		function show_map_error() {};
		function supports(bool, suffix) {
  var s = "Your browser ";
  if (bool) {
    s += "supports " + suffix + ".";
  } else {
    s += "does not support " + suffix + ". :(";
  }
  return s;
};        	
 	
		//detects whether geolocation is possible
		$(function() {
		  if (geoPosition.init()) {
		    $("#live-geolocation").html(supports(true, "geolocation") + ' <a href="#" onclick="lookup_location();return false">Click to look up your location</a>.');
		  } 
		  else {$("#live-geolocation").html(supports(false, "geolocation")); }
		  		 });    	
				
		function zoomto(x,y) {
			window.draggerstyle=$('#dragger')[0].getAttribute('style');
			if (draggerstyle)
				{
				var transbegin= draggerstyle.indexOf('-webkit-transform: translate(')+29;
				var transend=draggerstyle.indexOf('; -webkit-perspective:');
				var transxy=draggerstyle.substring(transbegin,transend);

				var transx= transxy.substring(0, transxy.indexOf('px, '));
				var transy= transxy.substring(transxy.indexOf('px, ')+4, transxy.indexOf('px)'));

				console.log(transx+', '+transy);
				}

			//d3.select('#markers').attr('display','none').transition().delay(2000).attr('display','block');
			$('#dragger').pep({});

			$('#zoomout').attr('style','');
			if ($('.zoomed').length==0){
				d3.select('#viewport')
				.attr('style','-webkit-transform-origin:'+(x)+' '+(y)+'; ')
				.attr('class','viewport zoomed');
			}
			
			//$('#dragger').attr('style','-webkit-transform:translate('+(x)+','+(y)+')');

			removelabel();
			
		};

		//Emerge stop markers when a bus is clicked
		function showroutestops(route, routedir){
		
			//clears previous stop markers
			$('.stopmarker').remove();
			
			d3.json('truncated_stops.json',function(json){
			
			window.data=json[fudge(routedir)]['Stops'];
			
			
			d3.select('#busstops')
				.selectAll("circle")
				.data(data)
				.enter()
				.append("circle")
				.attr("r", 0)
				.attr('class','stopmarker')
				.attr('cx',function(d,i){return lonx(data[i]['Lon'])})
				.attr('cy',function(d,i){return laty(data[i]['Lat'])})				
				.attr('fill',function(d,i) {if (i!=0 && i!=data.length-1){if (routedir.indexOf('OB')> -1) {return "#517D7C"} else {return "#CF4B62"}} else {return 'white'}})
				.attr('stroke',function(d,i) {if (i!=0 && i!=data.length-1) {return 'white'} 
												else {if (routedir.indexOf('OB')> -1) {return "#517D7C"} 
													else {return "#CF4B62"}}})
				.attr('stroke-width',function(d,i) {if (i!=0 && i!=data.length-1){return 1} else {return 2.5}})
				//.attr('name',function(d,i){return data[i]['Intersection']})

				.on('mouseover',function(d,i){
					d3.select(this)
						.transition()
						.duration(200)
						.attr('r',function(){ return ($(this)[0].getAttribute('r'))*1.5});

					var color= function(){if (routedir.indexOf('OB')> -1) {return "#517D7C"} else {return "#CF4B62"}};
					var stopdirection= function() {if (routedir.indexOf('OB')> -1) {if (i==0) {return 'Outbound line departs here'}  if (i==data.length-1){return 'Outbound line ends here'} else {return ' Outbound stop'}} 
													else {if (i==0) {return 'Inbound line departs here'}  if (i==data.length-1){return 'Inbound line ends here'} else {return 'Inbound stop'}}};


					makelabel(lonx(data[i]['Lon']),laty(data[i]['Lat']),data[i]['Intersection'],color, stopdirection);
					
			
				})
				.on('mouseout', function (){
					d3.select(this)
						.transition()
						.duration(200)
						.attr("r", 3);

					removelabel();
				})
				.transition()
				.delay(function(d,i){return 5*i})
				.duration(500)
				//.attr('size',function(d,i) {if (i!=0 && i!=data.length-1){return 3} else {return 5}})
				.attr("r", 3)
			})
			
		}
		
		//When a bus is clicked, grey out all buses that aren't on the same line, reveal stops, and move relevant stops and buses to the top of the stack		
		function showbusesonline(line) {
			$('.busmarker:not([route="'+line+'"])').attr('class','busmarker unselected');
			$('[route="'+line+'"]').attr('class','busmarker selected');
			d3.select('#busstops').moveToFront();
			d3.selectAll('.selected').moveToFront();
		}
		
		//Restore view to full, remove all stop markers and restore all buses to full color
		function zoombackout() {

			$('#dragger').attr('style','-webkit-transform:translate(0,0); -webkit-transition:all 2s');
			//$.pep.toggleAll(false);
			$('#view').attr('class','');
			$('#zoomout').attr('style','opacity:0');

			d3.select('.viewport')
			.attr('style','')
			.attr('class','viewport');
						
			$('.busmarker').attr('class','busmarker');
			$('.stopmarker').remove();


		}
		
		//hack to fix erroneous routdirs
		function fudge(routedir){
			var lastB= routedir.lastIndexOf('B');
			return routedir.substr(0,lastB+1);
			
		}
		
		window.labelscalefactor;

		//make label
		function makelabel(x,y,text,textcolor,subtext) {
					
					if ($('.zoomed').length==0) {
						labelscalefactor=' scale(1.5)';
					}
					else {labelscalefactor=' scale(1)'}
					d3.selectAll('#stoplabel').remove();
					d3.select('#busstoplabels')
						.attr('transform','translate('+(x+26)+' '+(y-10)+') '+labelscalefactor)					
						.append('text')
						.attr('x',6)
						.attr('y',15)
						.attr('font-size',8)
						.attr('fill',textcolor)
						.text(text)						
						.attr('id','stoplabel');

					d3.select('#busstoplabels')
						.append('text')
						.attr('x',6)
						.attr('y',25)
						.attr('font-size',6)
						.text(subtext)						
						.attr('id','stoplabel')
						.attr('class','subtext');
					
					//create background rectangle for label
					d3.select('#busstoplabels')
						.insert('rect','text')
						.attr('width',function(){return Math.max($('#stoplabel')[0].getComputedTextLength(), $('.subtext')[0].getComputedTextLength())+12})	
						.attr('height',32)
						.attr('id','labelrect');
						
		}
		
		function removelabel() {
					d3.selectAll('#stoplabel').remove();
					d3.selectAll('#labelrect').remove();
		}
		
		//Update user position		
		setInterval(function(){
			geoPosition.getCurrentPosition(get_latlon, show_map_error);
			current_location(lat,lon)}, 10000);
		
		
		//$("svg").on('mousemove',function(e){ 
            //$("#busstoplabels").attr("transform", "translate(" + [e.pageX+335] + "," + [e.pageY+60] + ")"); 
			//}); 

		



    </script>


    	<script src="geoPosition.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.pep/0.4.0/jquery.pep.min.js"></script>

</body></html>