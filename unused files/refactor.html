<html>
<body>
<div id='output'></div>
	<script src='d3.v3.min.js'></script>	
	<script src='jquery-1.9.1.min.js'></script>	

	<script>
		window.array={};
		
		function fudge(routedir){
			var lastB= routedir.lastIndexOf('B');
			return routedir.substr(0,lastB+1);
		}


    	// LAT-LON MASTER CONVERTERS
    	function lonx(lon){
    		return (8823*lon)+1081060-4;
    	}
    	function laty(lat) {
	    	return 422405-(11164.4*lat);
    	}


		$.getJSON('stops.json',function(json) {
			//console.log(json);
			//go through all the route numbers
			for(var i=0;i<json['route'].length; i++) {
					window.name=json['route'][i]['-title'];
				
				//in each route number, go through all the headings
				for(var j=0; j<json['route'][i]['direction'].length; j++){
					window.routedir=fudge(json['route'][i]['direction'][j]['-tag']);
					window.title=json['route'][i]['direction'][j]['-title'];
					window.stops=json['route'][i]['direction'][j]['stop'];
					
					array[routedir]={"Title": title, "Name": name, "Stops":[]};
					
					//in each heading, go through all the stop tags
					for (var k=0; k<stops.length; k++) {
						array[routedir]["Stops"][k]= {"Tag": stops[k]['-tag']};	
						
						//find the corresponding tag in the 'stop' node to get lat, lon, and title
						for (var l=0; l<json['route'][i]['stop'].length; l++){
							window.stopindex;
							if (json['route'][i]['stop'][l]['-tag']==stops[k]['-tag']) {
								stopindex=l;
								break;
							}
						}
						
						//array[routedir]["Stops"][k]["Lat"]=json['route'][i]['stop'][stopindex]['-lat'];
						//array[routedir]["Stops"][k]["Lon"]=json['route'][i]['stop'][stopindex]['-lon'];
						array[routedir]["Stops"][k]["xpos"]=lonx(json['route'][i]['stop'][stopindex]['-lon']);		
						array[routedir]["Stops"][k]["ypos"]=laty(json['route'][i]['stop'][stopindex]['-lat']);						
		
						array[routedir]["Stops"][k]["Intersection"]=json['route'][i]['stop'][stopindex]['-title'];
					}
					
		
					
					
				}
			}

			//create branch for route paths
			array["RoutePaths"]={};
			
			for(var i=0;i<json['route'].length; i++) {
						var line=json['route'][i]['-tag'];
						//array["RoutePaths"][i]=line;
						array['RoutePaths'][line]={"Subsegments":[]};

						//within "path," iterate through all the segments and provide a variable to store the path data
						for(var j=0;j<json['route'][i]['path'].length;j++) {
							var segment=json['route'][i]['path'][j]["point"];
							var pathdata;
							
							//within each segment, iterate through all the lat-lon pairs, convert to x-y, and construct a string with them
							for(var k=0;k<segment.length;k++){

								if(k==0){
									pathdata='M';
								}

								else	{pathdata+=' L'}
								pathdata+=lonx(segment[k]['-lon']);
								pathdata+=' ';
								pathdata+=laty(segment[k]['-lat']);
							}
							array['RoutePaths'][line]['Subsegments'][j]=pathdata;
						}
			}

		//text replaces
		var outputtext=JSON.stringify(array);
		var edited= outputtext
					//.replace(/Ave./g,'Ave')
					.replace(/ th /g,'th ')
					.replace(/___/g, '_')
					.replace(/__/g, '_')
					.replace(/Us Post/g, 'US Post')
					.replace(/St. /g, 'St ')
					.replace(/St." /g, 'St" ')
					.replace(/"0/g,'"');			
		$('#output').text(edited);

		})	
	
	</script>
</body>

</html>